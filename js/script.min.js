let GAME_={status:!1,end:!1,active:!1,score:0,combo:0,bestResult:window.localStorage.getItem("bestResult")?window.localStorage.getItem("bestResult"):0,newRecord:!1,designPalette:0};const colorDesign=[[30,70,50],[200,80,60]],boxSize={x:3,y:1,z:3,range:10},c_width=10,cameraPos={width:10,height:window.innerHeight/window.innerWidth*10,near:1,far:100,size:window.innerWidth>700?1:2};let world,scene,camera,renderer,stackBoxArr=[],outBoxArr=[];function playConfetti(){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(60,80)})}window.addEventListener("load",()=>{let resultTabDom=document.querySelector(".result-area"),pointDom=document.querySelector(".point-result"),scoreTab=document.querySelector(".score-tab"),comboStrike=document.querySelector(".combo-strike");function changeBackground(){scene.background=new THREE.Color(hslToHex(colorDesign[GAME_.designPalette][0]+120+4*stackBoxArr.length,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2]))}function printPoints(num){pointDom.innerHTML=num}function addOutBox(x,z,width,depth){const layerY=boxSize.y*(stackBoxArr.length-1),outBox=generateBox(x,layerY,z,width,depth,!0);outBoxArr.push(outBox)}function updatePhisics(){world.step(1/60),outBoxArr.forEach(i=>{i.threejs.position.copy(i.cannonjs.position),i.threejs.quaternion.copy(i.cannonjs.quaternion)})}function addLayer(x,z,width,depth,direction){const layerY=boxSize.y*stackBoxArr.length,layer=generateBox(x,layerY,z,width,depth,!1);layer.direction=direction,layer.positive=!0,stackBoxArr.push(layer)}function generateBox(x,y,z,width,depth,animation=!1){let colorPath=animation?4*(stackBoxArr.length-1):4*stackBoxArr.length;const color=new THREE.Color(hslToHex(colorDesign[GAME_.designPalette][0]+colorPath,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2])),geometry=new THREE.BoxGeometry(width,boxSize.y,depth),material=new THREE.MeshLambertMaterial({color:color}),mesh=new THREE.Mesh(geometry,material);mesh.position.set(x,y,z);const shape=new CANNON.Box(new CANNON.Vec3(width/2,boxSize.y/2,depth/2));let mass=animation?5:0;const body=new CANNON.Body({mass:mass,shape:shape});return body.position.set(x,y,z),world.addBody(body),scene.add(mesh),{threejs:mesh,geometry:geometry,material:material,cannonjs:body,x:x,y:y,z:z,width:width,depth:depth}}function hslToHex(h,s,l){l=l>101?100:l,l/=100;const a=s*Math.min(l,1-l)/100,f=n=>{const k=(n+h/30)%12,color=l-a*Math.max(Math.min(k-3,9-k,1),-1);return Math.round(255*color).toString(16).padStart(2,"0")};return`#${f(0)}${f(8)}${f(4)}`}function reset(){camera.position.set(4,4,4),camera.lookAt(0,0,0),stackBoxArr.forEach(i=>{scene.remove(i.threejs),i.geometry.dispose(),i.material.dispose(),world.removeBody(i.cannonjs)}),outBoxArr.forEach(i=>{scene.remove(i.threejs),i.geometry.dispose(),i.material.dispose(),world.removeBody(i.cannonjs)}),stackBoxArr=[],outBoxArr=[],GAME_.score=0,GAME_.combo=0,addLayer(0,0,boxSize.x,boxSize.z,"x")}world=new CANNON.World,world.gravity.set(0,-9.8,0),world.broadphase=new CANNON.NaiveBroadphase,world.solver.interations=40,printPoints(GAME_.bestResult),scene=new THREE.Scene,changeBackground(),addLayer(0,0,boxSize.x,boxSize.z,"x");const ambientLight=new THREE.AmbientLight(16777215,.6);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(16777215,.6);directionalLight.position.set(10,20,0),scene.add(directionalLight),camera=new THREE.OrthographicCamera(cameraPos.width/-cameraPos.size,cameraPos.width/cameraPos.size,cameraPos.height/cameraPos.size,cameraPos.height/-cameraPos.size,cameraPos.near,cameraPos.far),camera.position.set(4,4,4),camera.lookAt(0,0,0),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.render(scene,camera),document.body.appendChild(renderer.domElement);const fncStart=()=>{if(GAME_.status){let newWidth,newDepth;const lastLayer=stackBoxArr[stackBoxArr.length-1],previousLayer=stackBoxArr[stackBoxArr.length-2];let lastDirection=lastLayer.direction,delta=lastLayer.threejs.position[lastDirection]-previousLayer.threejs.position[lastDirection],alpha=Math.abs(delta),outbox="x"===lastDirection?lastLayer.width:lastLayer.depth,inbox=outbox-alpha;if(inbox>0){const boxRelation=inbox/outbox;boxRelation>=.9?([9,19,29,39,49].includes(GAME_.combo)&&(playConfetti(),GAME_.score+=10),GAME_.combo+=1,comboStrike.innerHTML=`x${GAME_.combo}`,comboStrike.classList.add("open"),setTimeout(()=>{comboStrike.classList.remove("open")},700)):GAME_.combo&&(GAME_.combo=0),newWidth="x"===lastDirection?inbox:lastLayer.width,newDepth="z"===lastDirection?inbox:lastLayer.depth,lastLayer.width=newWidth,lastLayer.depth=newDepth,lastLayer.threejs.scale[lastDirection]=boxRelation,lastLayer.threejs.position[lastDirection]-=delta/2,lastLayer.cannonjs.position[lastDirection]-=delta/2;const shape=new CANNON.Box(new CANNON.Vec3(newWidth/2,boxSize.y/2,newDepth/2));lastLayer.cannonjs.shapes=[],lastLayer.cannonjs.addShape(shape);let outboxCenter=Math.sign(delta)*(inbox/2+alpha/2);const outboxPos={x:"x"===lastDirection?lastLayer.threejs.position.x+outboxCenter:lastLayer.threejs.position.x,z:"z"===lastDirection?lastLayer.threejs.position.z+outboxCenter:lastLayer.threejs.position.z,width:"x"===lastDirection?alpha:newWidth,depth:"z"===lastDirection?alpha:newDepth};let x,z,direction;addOutBox(outboxPos.x,outboxPos.z,outboxPos.width,outboxPos.depth),addLayer("x"===lastDirection?lastLayer.threejs.position.x:-(boxSize.range-1),"z"===lastDirection?lastLayer.threejs.position.z:-(boxSize.range-1),newWidth,newDepth,"x"===lastDirection?"z":"x"),GAME_.score++,printPoints(GAME_.score)}else{GAME_.end=!0,world.remove(lastLayer.cannonjs);const shape=new CANNON.Box(new CANNON.Vec3(lastLayer.width/2,boxSize.y/2,lastLayer.depth/2));let mass=5;const body=new CANNON.Body({mass:mass,shape:shape});body.position.set(lastLayer.threejs.position.x,lastLayer.threejs.position.y,lastLayer.threejs.position.z),world.addBody(body),lastLayer.cannonjs=body,resultTabDom.classList.toggle("disable"),pointDom.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(),GAME_.bestResult=GAME_.score,window.localStorage.setItem("bestResult",GAME_.score),scoreTab.classList.add("new"),GAME_.newRecord=!0)}}else GAME_.active?reset():(renderer.setAnimationLoop(animation),GAME_.active=!0),printPoints(GAME_.score),addLayer(0,0,boxSize.x,boxSize.z,"z"),resultTabDom.classList.toggle("disable"),pointDom.classList.toggle("active"),GAME_.newRecord&&(GAME_.newRecord=!1,scoreTab.classList.remove("new")),GAME_.status=!0,GAME_.end=!1};function animation(){if(GAME_.end)stackBoxArr[stackBoxArr.length-1].threejs.position.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.position),stackBoxArr[stackBoxArr.length-1].threejs.quaternion.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.quaternion);else{const layer=stackBoxArr[stackBoxArr.length-1],speed=layer.positive?.15:-.15;layer.threejs.position[layer.direction]>=boxSize.range-5&&(layer.positive=!1),layer.threejs.position[layer.direction]<=-(boxSize.range-5)&&(layer.positive=!0),layer.threejs.position[layer.direction]+=speed,layer.cannonjs.position[layer.direction]+=speed,camera.position.y<boxSize.y*(stackBoxArr.length-2)+4&&(camera.position.y+=speed)}updatePhisics(),renderer.render(scene,camera)}let supportsTouch,eventType="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"click";window.addEventListener(eventType,fncStart)});